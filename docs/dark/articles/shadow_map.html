<!DOCTYPE html>
<html>
  <head>
    <title>Shadow Map Frustum â€¢ Nathan McMillan</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="/css/dark.css" />
  </head>
  <body>
    <header>
      <div class="header-left"><a href="/dark/index.html">nathan mcmillan</a></div>
      <div>
        <a href="/dark/articles.html">articles</a>
        <a href="/dark/projects.html">projects</a>
        <a href="/dark/photos.html">photos</a>
        <a href="/dark/resume.html">resume</a>
      </div>
    </header>
    <main class="articles">
      <section>
        <h1>How to calculate directional light frustum from the camera</h1>
        <div>04 June 2020</div>
        <pre><code>
void matrix_frustum_corners(vec4 *corners, float *matrix) {

    corners[0] = (vec4){-1, -1, -1, 1};
    corners[1] = (vec4){1, -1, -1, 1};
    corners[2] = (vec4){-1, 1, -1, 1};
    corners[3] = (vec4){1, 1, -1, 1};
    corners[4] = (vec4){-1, -1, 1, 1};
    corners[5] = (vec4){1, -1, 1, 1};
    corners[6] = (vec4){-1, 1, 1, 1};
    corners[7] = (vec4){1, 1, 1, 1};

    vec4 transform;
    for (int i = 0; i < 8; i++) {
        matrix_multiply_vector4(&transform, matrix, &corners[i]);
        corners[i].x = transform.x / transform.w;
        corners[i].y = transform.y / transform.w;
        corners[i].z = transform.z / transform.w;
        corners[i].w = 1;
    }
}
        </code></pre>
        <p>Blah</p>
        <pre><code>
void shadow_map_view_projection(shadowmap *shadow, float *out, float *shadow_view, float *view_projection) {

    vec3 shadow_direction = (vec3){-shadow_view[2], -shadow_view[6], -shadow_view[10]};
    vector3_normalize(&shadow_direction);

    float inverse_view_projection[16];
    matrix_inverse(inverse_view_projection, view_projection);

    vec4 corners[8];
    matrix_frustum_corners(corners, inverse_view_projection);

    float min_z = FLT_MAX;
    float max_z = FLT_MIN;

    for (int i = 0; i < 8; i++) {
        float z = corners[i].z;
        min_z = fmin(min_z, z);
        max_z = fmax(max_z, z);
    }

    float z_distance = max_z - min_z;

    vec3 center = {0};
    for (int i = 0; i < 8; i++) {
        vec4 *corner = &corners[i];
        center.x += corner->x;
        center.y += corner->y;
        center.z += corner->z;
    }

    VECTOR_3_DIVIDE(center, 8);

    float x = center.x - shadow_direction.x * z_distance;
    float y = center.y - shadow_direction.y * z_distance;
    float z = center.z - shadow_direction.z * z_distance;

    float world_units_per_texel = 1.0f / shadow->size;

    x = floorf(x / world_units_per_texel) * world_units_per_texel;
    y = floorf(y / world_units_per_texel) * world_units_per_texel;
    z = floorf(z / world_units_per_texel) * world_units_per_texel;

    matrix_translate(shadow_view, -x, -y, -z);

    float shadow_projection[16];

    float min_x = FLT_MAX;
    float max_x = FLT_MIN;
    float min_y = FLT_MAX;
    float max_y = FLT_MIN;

    min_z = FLT_MAX;
    max_z = FLT_MIN;

    for (int i = 0; i < 8; i++) {
        vec4 corner;
        matrix_multiply_vector4(&corner, shadow_view, &corners[i]);

        min_x = fmin(min_x, corner.x);
        max_x = fmax(max_x, corner.x);

        min_y = fmin(min_y, corner.y);
        max_y = fmax(max_y, corner.y);

        min_z = fmin(min_z, corner.z);
        max_z = fmax(max_z, corner.z);
    }

    z_distance = max_z - min_z;

    min_x = floorf(min_x / world_units_per_texel) * world_units_per_texel;
    max_x = floorf(max_x / world_units_per_texel) * world_units_per_texel;

    min_y = floorf(min_y / world_units_per_texel) * world_units_per_texel;
    max_y = floorf(max_y / world_units_per_texel) * world_units_per_texel;

    matrix_orthographic(shadow_projection, min_x, max_x, min_y, max_y, 0.001, z_distance);

    matrix_multiply(out, shadow_projection, shadow_view);
}
        </code></pre>
      </section>
      <div class="share">
        <a class="svg-link" href="/darkhttp://news.ycombinator.com/submitlink?u=dark/articles/shadow_map.html"><img src="/svg/hacker-news-square-brands.svg" /></a>
        <a class="svg-link" href="/darkhttps://www.reddit.com/submit?title=dark/articles/shadow_map.html"><img src="/svg/reddit-brands.svg" /></a>
      </div>
    </main>
    <hr />
    <footer>
      <a href="https://github.com/nathanmcmillan" title="visit my github"> <img class="testme" src="/svg/github-brands.svg" /></a>
      <a href="mailto:nate@domain.com" title="send me an email"> <img src="/svg/envelope-solid.svg" /></a>
      <a href="/articles/shadow_map.html" title="light color scheme"> <img src="/svg/moon-solid.svg" /></a>
    </footer>
  </body>
</html>
